<!-- templates/members.html -->
{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1">
                        <i class="bi bi-people-fill text-purple me-2"></i>
                        Member Management
                    </h4>
                    <p class="text-muted mb-0">Manage member advances and outstanding balances</p>
                </div>
                <span class="badge-gradient">
                    <i class="bi bi-cash-coin me-1"></i>Total Advances: KSH {{ "%.2f"|format(total_advances) }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Debt Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="glass-card p-4 bg-warning bg-opacity-10 border-warning">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="text-warning mb-1"><i class="bi bi-graph-down me-2"></i>Debt Repayment Progress</h5>
                    <p class="text-muted mb-0">10% of income is automatically applied to debt repayment</p>
                    
                    <!-- Debt Progress Bar -->
                    {% if debt.total_debt > 0 %}
                    {% set debt_paid = debt.total_debt - debt.remaining_debt %}
                    {% set debt_percentage = (debt_paid / debt.total_debt * 100) if debt.total_debt > 0 else 0 %}
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Progress: {{ "%.1f"|format(debt_percentage) }}%</small>
                            <small>KSH {{ "%.2f"|format(debt_paid) }} of KSH {{ "%.2f"|format(debt.total_debt) }}</small>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ debt_percentage }}%;" 
                                 aria-valuenow="{{ debt_percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-4 text-end">
                    <div class="row text-center">
                        <div class="col-6">
                            <h6 class="text-warning">Total Debt</h6>
                            <h4 class="text-warning">KSH {{ "%.2f"|format(debt.total_debt) }}</h4>
                        </div>
                        <div class="col-6">
                            <h6 class="text-success">Remaining</h6>
                            <h4 class="text-success">KSH {{ "%.2f"|format(debt.remaining_debt) }}</h4>
                        </div>
                    </div>
                </div>
            </div>
            {% if current_user.role == 'admin' %}
            <div class="mt-3">
                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#updateDebtModal">
                    <i class="bi bi-pencil me-1"></i>Update Debt
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    {% for member in members %}
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="glass-card p-4 h-100">
            <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3" style="background: {{ member.color }}20 !important;">
                    <i class="bi bi-person-fill fs-4" style="color: {{ member.color }}"></i>
                </div>
                <div>
                    <h5 class="mb-0" style="color: {{ member.color }}">{{ member.name }}</h5>
                    <small class="text-muted">
                        Share: {{ "%.1f"|format({'Bett': 77.5, 'Felix': 8.6, 'Willy': 13.9}[member.name]) }}%
                    </small>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="glass-card bg-light border-0">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Outstanding Advance:</span>
                            <span class="fs-5 fw-bold text-warning">KSH {{ "%.2f"|format(member.outstanding_advance) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            {% if member.email or member.phone %}
            <div class="mb-3">
                <small class="text-muted">Contact:</small>
                <div>
                    {% if member.email %}
                    <small><i class="bi bi-envelope me-1"></i>{{ member.email }}</small><br>
                    {% endif %}
                    {% if member.phone %}
                    <small><i class="bi bi-phone me-1"></i>{{ member.phone }}</small>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <form class="update-advance-form" data-member-id="{{ member.id }}">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Update Advance Balance</label>
                    <div class="input-group">
                        <span class="input-group-text">KSH </span>
                        <input type="number" step="0.01" name="advance" class="form-control" 
                               value="{{ "%.2f"|format(member.outstanding_advance) }}" required>
                    </div>
                    <div class="form-text">Set the current outstanding advance amount</div>
                </div>
                
                <button type="submit" class="btn w-100" style="background: {{ member.color }}; color: white;">
                    <i class="bi bi-check-circle me-1"></i>Update Balance
                </button>
            </form>

            {% if current_user.role == 'admin' %}
            <div class="mt-3">
                <button class="btn btn-sm btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#editMemberModal" 
                        data-member-id="{{ member.id }}" data-member-name="{{ member.name }}" 
                        data-member-email="{{ member.email or '' }}" data-member-phone="{{ member.phone or '' }}" 
                        data-member-color="{{ member.color }}">
                    <i class="bi bi-pencil me-1"></i>Edit Member
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Recent Advances -->
<div class="glass-card p-4 mt-4">
    <h5 class="mb-3"><i class="bi bi-clock-history text-info me-2"></i>Recent Advance Activity</h5>
    {% if recent_advances %}
    <div class="table-responsive">
        <table class="table table-dark table-sm">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Member</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th>Week</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for advance in recent_advances %}
                <tr>
                    <td><small>{{ advance.advance_date.strftime('%Y-%m-%d') }}</small></td>
                    <td>
                        <span class="badge" style="background: {{ members|selectattr('name', 'equalto', advance.member_name)|map(attribute='color')|first }}; color: white;">
                            {{ advance.member_name }}
                        </span>
                    </td>
                    <td class="text-warning fw-bold">KSH {{ "%.2f"|format(advance.amount) }}</td>
                    <td><small class="text-muted">{{ advance.description or '-' }}</small></td>
                    <td><small>{{ advance.week_start.strftime('%m/%d') }} - {{ advance.week_end.strftime('%m/%d') }}</small></td>
                    <td>
                        {% if current_user.role == 'admin' or advance.created_by == current_user.id %}
                        <button class="btn btn-sm btn-outline-danger delete-advance-btn" 
                                data-advance-id="{{ advance.id }}" 
                                data-member-name="{{ advance.member_name }}"
                                data-amount="{{ advance.amount }}">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-3 text-muted">
        <i class="bi bi-cash-coin display-6"></i>
        <p class="mt-2">No recent advance activity</p>
    </div>
    {% endif %}
</div>

<!-- Member Statistics -->
<div class="glass-card p-4 mt-4">
    <h5 class="mb-3"><i class="bi bi-graph-up text-success me-2"></i>Member Performance Statistics</h5>
    <div class="row">
        {% for member in members %}
        <div class="col-md-4 mb-3">
            <div class="glass-card p-3 border-start" style="border-left-color: {{ member.color }} !important; border-left-width: 4px !important;">
                <h6 style="color: {{ member.color }}">{{ member.name }}</h6>
                <div class="row text-center">
                    <div class="col-6">
                        <small class="text-muted">Total Payout</small>
                        <div class="fw-bold text-success">KSH {{ "%.2f"|format(member_stats[member.name].total_payout if member_stats else 0) }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Net Balance</small>
                        <div class="fw-bold text-{{ 'success' if (member_stats[member.name].net_balance if member_stats else 0) >= 0 else 'danger' }}">
                            KSH {{ "%.2f"|format(member_stats[member.name].net_balance if member_stats else 0) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Information Cards -->
<div class="glass-card p-4 mt-4">
    <h5 class="mb-3"><i class="bi bi-info-circle text-info me-2"></i>About Advances & Debt</h5>
    <div class="row g-3">
        <div class="col-md-6">
            <div class="glass-card bg-info bg-opacity-10 border-info">
                <div class="card-body">
                    <h6 class="text-info">🔄 Advance Redistribution</h6>
                    <p class="mb-0 small">When a member takes more advance than their weekly share, the excess amount is redistributed to other members proportionally to their shares.</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="glass-card bg-warning bg-opacity-10 border-warning">
                <div class="card-body">
                    <h6 class="text-warning">⚡ Real-time Impact</h6>
                    <p class="mb-0 small">Advances directly reduce weekly payouts. Members with negative payouts receive zero that week, and their excess advances are carried forward.</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="glass-card bg-success bg-opacity-10 border-success">
                <div class="card-body">
                    <h6 class="text-success">💰 Debt Management</h6>
                    <p class="mb-0 small">10% of gross income is automatically allocated to debt repayment. This amount reduces the remaining debt balance each week.</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="glass-card bg-primary bg-opacity-10 border-primary">
                <div class="card-body">
                    <h6 class="text-primary">📊 Member Analytics</h6>
                    <p class="mb-0 small">Monitor individual member performance, total payouts, and advance patterns for better financial decision making.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Debt Modal -->
{% if current_user.role == 'admin' %}
<div class="modal fade" id="updateDebtModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-graph-down me-2"></i>Update Debt Information</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateDebtForm">
                    <div class="mb-3">
                        <label class="form-label">Total Debt</label>
                        <div class="input-group">
                            <span class="input-group-text">KSH</span>
                            <input type="number" step="0.01" class="form-control" value="{{ "%.2f"|format(debt.total_debt) }}" readonly>
                        </div>
                        <div class="form-text">Total debt accumulated from all settlements</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remaining Debt</label>
                        <div class="input-group">
                            <span class="input-group-text">KSH</span>
                            <input type="number" step="0.01" name="remaining_debt" class="form-control" value="{{ "%.2f"|format(debt.remaining_debt) }}" required>
                        </div>
                        <div class="form-text">Update the remaining debt amount after payments. 10% of weekly income is automatically deducted from this amount.</div>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Note:</strong> The system automatically applies 10% of weekly income to reduce the remaining debt. 
                            Use this form to manually adjust the remaining balance if needed.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-warning" id="saveDebtBtn">Update Debt</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Member Modal -->
<div class="modal fade" id="editMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-gear me-2"></i>Edit Member</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMemberForm">
                    <input type="hidden" name="member_id" id="editMemberId">
                    <div class="mb-3">
                        <label class="form-label">Member Name</label>
                        <input type="text" class="form-control" id="editMemberName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email Address</label>
                        <input type="email" name="email" class="form-control" id="editMemberEmail">
                        <div class="form-text">For notification purposes</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="text" name="phone" class="form-control" id="editMemberPhone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" name="color" class="form-control form-control-color" id="editMemberColor">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="saveMemberBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Advance Confirmation Modal -->
<div class="modal fade" id="deleteAdvanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Deletion</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this advance?</p>
                <div class="alert alert-warning">
                    <strong>Member:</strong> <span id="deleteMemberName"></span><br>
                    <strong>Amount:</strong> KSH <span id="deleteAdvanceAmount"></span>
                </div>
                <p class="text-muted small">This action will also update the member's outstanding advance balance.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteAdvanceBtn">Delete Advance</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update Advance Balance
    document.querySelectorAll('.update-advance-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const memberId = this.dataset.memberId;
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            fetch(`/api/update_advance/${memberId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating advance balance');
            });
        });
    });

    // Delete Advance
    let currentAdvanceId = null;
    document.querySelectorAll('.delete-advance-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentAdvanceId = this.dataset.advanceId;
            document.getElementById('deleteMemberName').textContent = this.dataset.memberName;
            document.getElementById('deleteAdvanceAmount').textContent = this.dataset.amount;
            
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteAdvanceModal'));
            deleteModal.show();
        });
    });

    // Confirm Delete Advance
    document.getElementById('confirmDeleteAdvanceBtn').addEventListener('click', function() {
        if (!currentAdvanceId) return;
        
        fetch(`/api/delete_advance/${currentAdvanceId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert(result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting advance');
        });
    });

    {% if current_user.role == 'admin' %}
    // Update Debt
    document.getElementById('saveDebtBtn').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('updateDebtForm'));
        const data = Object.fromEntries(formData);
        
        fetch('/api/update_debt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert(result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating debt');
        });
    });

    // Edit Member Modal
    const editMemberModal = document.getElementById('editMemberModal');
    editMemberModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        document.getElementById('editMemberId').value = button.dataset.memberId;
        document.getElementById('editMemberName').value = button.dataset.memberName;
        document.getElementById('editMemberEmail').value = button.dataset.memberEmail;
        document.getElementById('editMemberPhone').value = button.dataset.memberPhone;
        document.getElementById('editMemberColor').value = button.dataset.memberColor;
    });

    // Save Member Changes
    document.getElementById('saveMemberBtn').addEventListener('click', function() {
        const memberId = document.getElementById('editMemberId').value;
        const formData = new FormData(document.getElementById('editMemberForm'));
        const data = Object.fromEntries(formData);
        
        fetch(`/api/update_member/${memberId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert(result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating member');
        });
    });
    {% endif %}

    // Auto-refresh member statistics (optional)
    function refreshMemberStats() {
        fetch('/api/get_settlement_stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update any dynamic statistics if needed
                console.log('Member stats updated');
            }
        })
        .catch(error => console.error('Error refreshing stats:', error));
    }

    // Refresh stats every 30 seconds
    setInterval(refreshMemberStats, 30000);
});
</script>
{% endblock %}
