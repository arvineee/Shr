<!-- templates/index.html -->
{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1"><i class="bi bi-calculator text-primary me-2"></i>Weekly Settlement Calculator</h4>
                    <p class="text-muted mb-0">Week: <strong>{{ week_start.strftime('%b %d') }} — {{ week_end.strftime('%b %d, %Y') }}</strong> (Monday → Sunday)</p>
                </div>
                <span class="badge-gradient">
                    <i class="bi bi-info-circle me-1"></i>Real-time Calculation
                </span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Quick Stats -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-md-3 col-6 mb-3">
                <div class="glass-card p-3 text-center">
                    <h6 class="text-primary">Total Debt</h6>
                    <h4 class="text-primary">KSH {{ "%.2f"|format(debt.total_debt) }}</h4>
                    <small class="text-muted">Remaining: KSH {{ "%.2f"|format(debt.remaining_debt) }}</small>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="glass-card p-3 text-center">
                    <h6 class="text-success">Total Advances</h6>
                    <h4 class="text-success">KSH {{ "%.2f"|format(current_advances.values()|sum) }}</h4>
                    <small class="text-muted">This Week</small>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="glass-card p-3 text-center">
                    <h6 class="text-info">Active Members</h6>
                    <h4 class="text-info">{{ members|length }}</h4>
                    <small class="text-muted">Registered</small>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="glass-card p-3 text-center">
                    <h6 class="text-warning">Recent Settlements</h6>
                    <h4 class="text-warning">{{ recent_settlements|length }}</h4>
                    <small class="text-muted">Last 3</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column: Settlement Form & Advance Management -->
    <div class="col-lg-8">
        <!-- Advance Management Section -->
        <div class="glass-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-cash-coin text-warning me-2"></i>Manage Weekly Advances</h5>
                <span class="badge bg-warning">Total: KSH {{ "%.2f"|format(current_advances.values()|sum) }}</span>
            </div>
            
            <!-- Add Advance Form -->
            <form id="addAdvanceForm" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Member</label>
                        <select name="member_name" class="form-select" required>
                            <option value="">Select Member</option>
                            <option value="Bett">Bett</option>
                            <option value="Felix">Felix</option>
                            <option value="Willy">Willy</option>
                        </select>
                        <div class="form-text">Choose a member to add advance for</div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">KSH</span>
                            <input type="number" step="0.01" name="amount" class="form-control" placeholder="0.00" min="0.01" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Description</label>
                        <input type="text" name="description" class="form-control" placeholder="Optional note">
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-plus-circle me-1"></i>Add Advance
                    </button>
                </div>
            </form>

            <!-- Current Week Advances -->
            <h6 class="mb-3">This Week's Advances</h6>
            {% if advance_history %}
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Member</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="advancesTableBody">
                        {% for advance in advance_history %}
                        <tr id="advance-{{ advance.id }}">
                            <td><small>{{ advance.advance_date.strftime('%m/%d') }}</small></td>
                            <td>
                                {% if advance.member_name == 'Bett' %}
                                <span class="badge" style="background: #2ecc71; color: white;">Bett</span>
                                {% elif advance.member_name == 'Felix' %}
                                <span class="badge" style="background: #e74c3c; color: white;">Felix</span>
                                {% else %}
                                <span class="badge" style="background: #3498db; color: white;">Willy</span>
                                {% endif %}
                            </td>
                            <td class="text-warning fw-bold">KSH {{ "%.2f"|format(advance.amount) }}</td>
                            <td><small class="text-muted">{{ advance.description or '-' }}</small></td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger delete-advance" data-advance-id="{{ advance.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-3 text-muted">
                <i class="bi bi-cash-coin display-6"></i>
                <p class="mt-2">No advances recorded for this week yet</p>
            </div>
            {% endif %}
        </div>

        <!-- Settlement Form -->
        <div class="glass-card p-4">
            <form id="settlementForm">
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">📅 Reference Date</label>
                        <input type="date" name="ref_date" class="form-control" value="{{ today.isoformat() }}">
                        <div class="form-text">Pick any day to determine the week (Monday-Sunday)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">💰 Total Weekly Income</label>
                        <div class="input-group">
                            <span class="input-group-text">KSH</span>
                            <input type="number" step="0.01" name="total_income" class="form-control" placeholder="Enter gross income" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">📊 Total Weekly Expenses</label>
                        <div class="input-group">
                            <span class="input-group-text">KSH</span>
                            <input type="number" step="0.01" name="total_expenses" class="form-control" placeholder="Other than rent/milk/salary" required>
                        </div>
                    </div>

                    <!-- Felix Substitute Option -->
                    <div class="col-md-6">
                        <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" name="felix_substitute" id="felix_substitute">
                            <label class="form-check-label fw-semibold" for="felix_substitute">
                                <i class="bi bi-person-check text-info me-1"></i>Felix Substitute This Week
                            </label>
                            <div class="form-text">When checked: Substitute gets salary, but Felix keeps his shares</div>
                        </div>
                    </div>
                </div>

                <!-- Current Advances Summary -->
                <div class="mt-4">
                    <h6 class="mb-3">Current Advances Summary</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="glass-card border-2" style="border-color: #2ecc71 !important;">
                                <div class="card-body text-center p-3">
                                    <h6 class="card-title" style="color: #2ecc71">Bett</h6>
                                    <h5 class="fw-bold text-warning">KSH {{ "%.2f"|format(current_advances.get('Bett', 0)) }}</h5>
                                    <small class="text-muted">77.5% share</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="glass-card border-2" style="border-color: #e74c3c !important;">
                                <div class="card-body text-center p-3">
                                    <h6 class="card-title" style="color: #e74c3c">Felix</h6>
                                    <h5 class="fw-bold text-warning">KSH {{ "%.2f"|format(current_advances.get('Felix', 0)) }}</h5>
                                    <small class="text-muted">8.6% share</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="glass-card border-2" style="border-color: #3498db !important;">
                                <div class="card-body text-center p-3">
                                    <h6 class="card-title" style="color: #3498db">Willy</h6>
                                    <h5 class="fw-bold text-warning">KSH {{ "%.2f"|format(current_advances.get('Willy', 0)) }}</h5>
                                    <small class="text-muted">13.9% share</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 text-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="bi bi-lightning-charge me-2"></i>Compute & Save Settlement
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Right Column: Rules & Stats -->
    <div class="col-lg-4">
        <div class="glass-card p-4">
            <h5 class="mb-3"><i class="bi bi-journal-text text-success me-2"></i>Business Rules</h5>
            <div class="row g-3">
                <div class="col-12">
                    <div class="glass-card bg-light border-0">
                        <div class="card-body">
                            <h6 class="card-title">📈 Fixed Shares</h6>
                            <div class="d-flex justify-content-between">
                                <span>Bett:</span><strong class="text-success">77.5%</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Felix:</span><strong class="text-danger">8.6%</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Willy:</span><strong class="text-info">13.9%</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="glass-card bg-light border-0">
                        <div class="card-body">
                            <h6 class="card-title">💰 Fixed Deductions</h6>
                            <small class="text-muted">Felix Salary: KSH 1,000/day × 7 = KSH 7,000/week</small><br>
                            <small class="text-muted">Debt Repayment: 10% of gross income</small>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="glass-card bg-light border-0">
                        <div class="card-body">
                            <h6 class="card-title">🏠 Monthly Deductions</h6>
                            <small class="text-muted">Rent: KSH 12,000 (last week)</small><br>
                            <small class="text-muted">Milk: KSH 1,500 (last week)</small>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="glass-card bg-info bg-opacity-10 border-info">
                        <div class="card-body">
                            <h6 class="card-title text-info">👥 Felix Substitute Rule</h6>
                            <small>When substitute works: Salary goes to substitute, but Felix's shares (8.6%) remain with Felix in calculations.</small>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="glass-card bg-warning bg-opacity-10 border-warning">
                        <div class="card-body">
                            <h6 class="card-title text-warning">⚡ Advance Handling</h6>
                            <small>Add advances as they occur during the week. They'll automatically be included in the final settlement calculation.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Settlements -->
        {% if recent_settlements %}
        <div class="glass-card p-4 mt-4">
            <h5 class="mb-3"><i class="bi bi-clock-history text-info me-2"></i>Recent Settlements</h5>
            <div class="list-group">
                {% for settlement in recent_settlements %}
                <a href="{{ url_for('main.settlement_detail', settlement_id=settlement.id) }}" class="list-group-item list-group-item-action glass-card border-0 mb-2">
                    <div class="d-flex justify-content-between">
                        <small class="fw-bold">{{ settlement.week_start.strftime('%b %d') }} - {{ settlement.week_end.strftime('%b %d') }}</small>
                        <small class="text-success">KSH {{ "%.2f"|format(settlement.net_distributable) }}</small>
                    </div>
                    <small class="text-muted">Income: KSH {{ "%.2f"|format(settlement.total_income) }}</small>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add Advance Form
    document.getElementById('addAdvanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        fetch('/api/add_advance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(result.message, 'success');
                this.reset();
                location.reload(); // Reload to show updated advances
            } else {
                showAlert(result.message, 'error');
            }
        })
        .catch(error => {
            showAlert('Error adding advance', 'error');
        });
    });

    // Delete Advance
    document.querySelectorAll('.delete-advance').forEach(button => {
        button.addEventListener('click', function() {
            const advanceId = this.dataset.advanceId;
            if (confirm('Are you sure you want to delete this advance?')) {
                fetch(`/api/delete_advance/${advanceId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showAlert(result.message, 'success');
                        document.getElementById(`advance-${advanceId}`).remove();
                    } else {
                        showAlert(result.message, 'error');
                    }
                });
            }
        });
    });

    // Settlement Form
    document.getElementById('settlementForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        data.felix_substitute = document.getElementById('felix_substitute').checked;
        
        fetch('/api/create_settlement', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(result.message, 'success');
                window.location.href = `/settlement/${result.settlement_id}`;
            } else {
                showAlert(result.message, 'error');
            }
        })
        .catch(error => {
            showAlert('Error creating settlement', 'error');
        });
    });

    function showAlert(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show glass-card`;
        alertDiv.innerHTML = `
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
    }
});
</script>
{% endblock %}
